<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Submit Abstract</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h3>Welcome, {{ username }}</h3>

    <div class="mb-3">
      <label for="model" class="form-label">Select Model:</label>
      <select id="model" class="form-select" onchange="loadAbstract()">
        <option value="" disabled selected>Select a model</option>
        <option value="gemini_flash">Gemini Flash</option>
        <option value="grok">Grok</option>
        <option value="claude">Claude</option>
      </select>
    </div>

    <div id="abstract-box" style="display: none;">
      <div class="card p-3 mb-3">
        <h5>Title:</h5>
        <p id="abstract-title" class="fw-bold"></p>
      </div>

      <div class="mb-3">
        <label for="response" class="form-label">Your Abstract Response:</label>
        <textarea id="response" class="form-control" rows="10" required></textarea>
      </div>

      <button class="btn btn-primary" onclick="submitResponse()">Submit</button>
    </div>

    <div id="status" class="mt-3"></div>
    <a href="/logout" class="btn btn-secondary mt-3">Logout</a>
  </div>

  <script>
    let currentAbstract = null;

    async function loadAbstract() {
      const model = document.getElementById('model').value;
      const res = await fetch(`/get_next/${model}`);
      const data = await res.json();

      if (!data || !data.title) {
        document.getElementById('status').innerHTML = `<div class="alert alert-warning">No more abstracts available for this model.</div>`;
        document.getElementById('abstract-box').style.display = 'none';
        return;
      }

      currentAbstract = data;
      document.getElementById('abstract-title').innerText = data.title;
      document.getElementById('response').value = "";
      document.getElementById('abstract-box').style.display = 'block';
    }

    async function submitResponse() {
      const response = document.getElementById('response').value.trim();
      const model = document.getElementById('model').value;

      if (!response) {
        alert("Please enter your abstract response.");
        return;
      }

      const payload = {
        uuid: currentAbstract.uuid,
        id: currentAbstract.id,
        title: currentAbstract.title,
        response: response
      };

      const res = await fetch(`/submit/${model}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const result = await res.json();
      if (result.status === 'success') {
        document.getElementById('status').innerHTML = `<div class="alert alert-success">Response submitted successfully.</div>`;
        loadAbstract(); // Load next abstract
      } else {
        document.getElementById('status').innerHTML = `<div class="alert alert-danger">Submission failed.</div>`;
      }
    }
  </script>
</body>
</html>
